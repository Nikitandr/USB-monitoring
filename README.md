# USB Monitor Security System

Система безопасности для контроля подключения USB-устройств в корпоративной сети.

## Описание

USB Monitor Security System - это решение для обеспечения безопасности операционной системы путем контроля подключения USB-устройств. Система состоит из:

- **Сервера администратора** (Windows 11) - централизованное управление политиками и мониторинг
- **Клиентов** (Linux Ubuntu 22.04) - демоны на рабочих станциях для контроля USB-устройств

## Архитектура

### Сервер (Windows 11)
- Flask веб-приложение с админ-панелью
- SQLite база данных для хранения пользователей, устройств и разрешений
- WebSocket для real-time уведомлений
- REST API для взаимодействия с клиентами

### Клиент (Linux Ubuntu 22.04)
- Системный демон (systemd service)
- Отключение автомонтирования USB через udev/polkit правила
- Контролируемое монтирование через UDisks2 D-Bus API
- Определение активного пользователя с fallback методами
- Desktop уведомления для пользователей

## Принцип работы

1. **Отключение автомонтирования**: Система полностью отключает стандартное автомонтирование USB-устройств
2. **Перехват событий**: Клиент отслеживает подключение USB-устройств через udev
3. **Проверка разрешений**: Для каждого устройства проверяется разрешение на сервере по VID/PID/Serial
4. **Обработка результата**:
   - **Разрешено** → устройство монтируется
   - **Запрещено** → устройство блокируется
   - **Неизвестно** → отправляется запрос администратору
5. **Безопасность**: При недоступности сервера все устройства блокируются

## Установка

### Сервер (Windows 11)

1. Установите Python 3.8+
2. Клонируйте репозиторий
3. Установите зависимости:
   ```bash
   cd server
   pip install -r requirements.txt
   ```
4. Запустите сервер:
   ```bash
   python app.py
   ```
5. Откройте http://localhost:5000 в браузере
6. Войдите как администратор (admin/admin)

### Клиент (Linux Ubuntu 22.04)

1. Скопируйте папку `source/` на клиентскую машину
2. Запустите установку от root:
   ```bash
   sudo ./install_client.sh
   ```
3. Отредактируйте конфигурацию:
   ```bash
   sudo nano /etc/usb-monitor/config.yaml
   ```
   Укажите URL сервера:
   ```yaml
   server:
     server_url: "http://IP_СЕРВЕРА:5000"
   ```
4. Запустите службу:
   ```bash
   sudo systemctl start usb-monitor
   ```

## Конфигурация

### Сервер

Настройки в `server/config.py`:
- Порт и хост сервера
- Учетные данные администратора
- Пути к базе данных и логам

### Клиент

Настройки в `/etc/usb-monitor/config.yaml`:
```yaml
server:
  server_url: "http://192.168.1.100:5000"  # URL сервера
  timeout: 10                              # Таймаут запросов
  retry_attempts: 3                        # Количество попыток
  retry_delay: 5                           # Задержка между попытками
  cache_duration: 300                      # Время кэширования (сек)
```

## Управление

### Команды клиента

```bash
# Статус службы
sudo systemctl status usb-monitor

# Запуск/остановка
sudo systemctl start usb-monitor
sudo systemctl stop usb-monitor

# Автозапуск
sudo systemctl enable usb-monitor
sudo systemctl disable usb-monitor

# Просмотр логов
journalctl -u usb-monitor -f

# Перезагрузка конфигурации
sudo systemctl restart usb-monitor
```

### Веб-интерфейс администратора

- **Dashboard** - общая статистика и ожидающие запросы
- **Users** - управление пользователями и их устройствами
- **Requests** - история всех запросов на подключение
- **Real-time** - мгновенные уведомления о новых запросах

## API

### Проверка устройства
```http
POST /api/devices/check
Content-Type: application/json

{
  "username": "user1",
  "vid": "0781",
  "pid": "5567",
  "serial": "123456"
}
```

### Создание запроса
```http
POST /api/requests
Content-Type: application/json

{
  "username": "user1",
  "vid": "0781",
  "pid": "5567", 
  "serial": "123456",
  "device_info": "SanDisk Cruzer Blade"
}
```

## Безопасность

### Принципы безопасности
- **Fail-safe**: При недоступности сервера все устройства блокируются
- **Централизованное управление**: Локальные списки не используются
- **Аудит**: Все события логируются
- **Минимальные привилегии**: Демон работает с ограниченными правами

### Защищенные компоненты
- Отключение автомонтирования через системные правила
- Контролируемое монтирование только разрешенных устройств
- Шифрование трафика (при использовании HTTPS)
- Аутентификация администратора

## Мониторинг

### Логи клиента
```bash
# Системные логи
journalctl -u usb-monitor

# Фильтрация по уровню
journalctl -u usb-monitor -p err

# Последние события
journalctl -u usb-monitor --since "1 hour ago"
```

### Логи сервера
- Файл: `server/logs/usb_monitor.log`
- Уровни: DEBUG, INFO, WARNING, ERROR
- Ротация логов настраивается в конфигурации

## Устранение неполадок

### Клиент не запускается
1. Проверьте права root: `sudo systemctl status usb-monitor`
2. Проверьте зависимости: `python3 -c "import pyudev, yaml, requests, pydbus"`
3. Проверьте конфигурацию: `sudo nano /etc/usb-monitor/config.yaml`

### Устройства не монтируются
1. Проверьте подключение к серверу в логах
2. Убедитесь, что пользователь определяется корректно
3. Проверьте права на `/media/`

### Сервер недоступен
1. Проверьте сетевое подключение
2. Убедитесь, что сервер запущен
3. Проверьте firewall и порты

## Разработка

### Структура проекта
```
USB_monitoring/
├── server/                 # Серверная часть
│   ├── app.py             # Основное приложение
│   ├── database/          # Модели БД
│   ├── web/               # Веб-интерфейс
│   └── config.py          # Конфигурация
├── source/                # Клиентская часть
│   ├── monitor.py         # Основной демон
│   ├── config.yaml        # Конфигурация клиента
│   ├── rules/             # Генераторы правил
│   ├── usb-monitor.service # Systemd unit
│   └── install_client.sh  # Скрипт установки
└── tests/                 # Тесты
```

### Требования
- **Сервер**: Python 3.8+, Flask, SQLite
- **Клиент**: Python 3.8+, pyudev, pydbus, systemd

## Лицензия

Проект создан для демонстрации концепции безопасности USB-устройств.
Не предназначен для продакшн использования без дополнительной доработки.
